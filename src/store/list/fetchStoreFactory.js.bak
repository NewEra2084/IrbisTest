// store/base/fetchStoreFactory.js
import { create } from "zustand";
import {collectionsApi} from "@/js/api/collections/collectionsApi";

/**
 * Ð£Ð½Ð¸Ð²ÐµÑ€ÑÐ°Ð»ÑŒÐ½Ñ‹Ð¹ fetchStore Ñ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¾Ð¹ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð°
 * @param {string} name â€” Ð¸Ð¼Ñ ÐºÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ð¸
 * @param {(filters, item) => boolean} filterItemPredicate â€” Ð¿Ñ€ÐµÐ´Ð¸ÐºÐ°Ñ‚ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸Ð¸
 */
export function createFetchStore({ name, idName="id", filterItemPredicate = null }){
    return (set, get) => ({
        name,
        items: [],
               isLoading: false,
               isLoaded: false,
               error: null,

               getCollectionName: () => {
                   const {name} = get();
                   return name;
               },

               getItemName: () => {
                   const {name} = get();

                   if (name.endsWith("s")){
                        return name.substring(0,name.length-1);
                   }
                   return name;
               },

               getItems: () => {
                    const {items,getItemName} = get();
                    return items.map(item=>({
                            id:item[idName],
                            type: getItemName(),
                            item
                        })
                    );
               },

               /**
                * Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ Ð¾Ñ‚Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ñ‹
                * @param filters â€” Ð¾Ð±ÑŠÐµÐºÑ‚ Ñ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ð¼Ð¸
                */
               getFilteredItems: (filters = {}) => {
                 const { items } = get();
                 if (!filterItemPredicate) return items;
                 return items.filter((item) => filterItemPredicate(filters, item));
               },

               /**
                * Ð£Ð½Ð¸Ð²ÐµÑ€ÑÐ°Ð»ÑŒÐ½Ñ‹Ð¹ setter Ð´Ð»Ñ items
                */
               setItems: (items, markLoaded = true) =>
                 set({
                   items: Array.isArray(items) ? items : [],
                   isLoaded: !!markLoaded,
                   isLoading: false,
                   error: null,
                 }),

               fetchAll: async (force = false) => {
                 const { name, isLoaded, items: prevItems } = get();
                 if (isLoaded && !force) return;

                 set({ isLoading: true, error: null });
                 try {
                   const data = await collectionsApi[name].list();

                   console.log(`[${name}] fetched data:`, data);

                   // ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð»Ð°ÑÑŒ Ð»Ð¸ ÑÑÑ‹Ð»ÐºÐ° Ð½Ð° Ð¼Ð°ÑÑÐ¸Ð²
                   const isSameRef = prevItems === data;
                   console.log(`[${name}] items same reference?`, isSameRef);

                   set({ items: data, isLoaded: true });
                 } catch (error) {
                   console.error(`[${name}] fetch error:`, error);
                   set({ error });
                 } finally {
                   set({ isLoading: false });
                 }
               },

               getById: (id) => get().items.find((x) => x.id === id),

               addItem: (item) => set((state) => ({ items: [...state.items, item] })),
               updateItem: (id, updates) =>
                 set((state) => ({
                   items: state.items.map((x) => (x.id === id ? { ...x, ...updates } : x)),
                 })),
               removeItem: (id) =>
                 set((state) => ({ items: state.items.filter((x) => x.id !== id) })),

               clear: () => set({ items: [], isLoaded: false, error: null }),
             });
};
